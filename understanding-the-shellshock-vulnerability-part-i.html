<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Understanding the Shellshock Vulnerability - Part I</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="bt3gl">

    <!-- Le styles -->
    <link rel="stylesheet" href="http://bt3gl.github.io/theme/css/bootstrap.dark.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 11pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-4 {
        font-size: 8pt;
     }
    </style>
    <link href="http://bt3gl.github.io/theme/css/bootstrap-responsive.dark.css" rel="stylesheet">
        <link href="http://bt3gl.github.io/theme/css/font-awesome.css" rel="stylesheet">

    <link href="http://bt3gl.github.io/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://bt3gl.github.io/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://bt3gl.github.io/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://bt3gl.github.io/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://bt3gl.github.io/theme/images/apple-touch-icon-114x114.png">

    <link href="http://bt3gl.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="High Bytes by bt3gl ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://bt3gl.github.io/index.html">High Bytes by bt3gl </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>


                          <ul class="nav pull-right">
                                <li><a href="http://bt3gl.github.io/authors.html">About</a></li>
                                <li><a href="https://github.com/bt3gl">GitHub</a></li>
                                <li><a href="https://twitter.com/bt3gl">Twitter</a></li>
                                <li><a href="https://coderwall.com/p/kubxjq?i=11&p=2&q=author%3Abt3gl&t%5B%5D=bt3gl">CodeWall</a></li>
                                <li><a href="http://dev.mariwahl.us/">Projects</a></li>
                                <li><a href="http://bt3gl.github.io/archives.html"><b>Archives</b></a></li>

                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Understanding the Shellshock Vulnerability - Part I">
                                        Understanding the Shellshock Vulnerability - Part I
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<abbr class="published" title="2014-09-30T05:21:00">
      Tue 30 September 2014 </abbr>

<span class="label"> Category</span>
<a href="http://bt3gl.github.io/category/vulnerabilities.html"><i class="icon-folder-open"></i>Vulnerabilities</a>


<span class="label">Tags</span>
	<a href="http://bt3gl.github.io/tag/shellshock.html"><i class="icon-tag"></i>Shellshock</a>
	<a href="http://bt3gl.github.io/tag/bash.html"><i class="icon-tag"></i>Bash</a>
	<a href="http://bt3gl.github.io/tag/command-injection.html"><i class="icon-tag"></i>Command Injection</a>
</footer><!-- /.post-info -->                </div>
                <p><img alt="" src="http://i.imgur.com/kjkWTWV.png" /></p>
<p>Almost a week ago, a new (<a href="http://blog.erratasec.com/2014/09/shellshock-is-20-years-old-get-off-my.html">old</a>) type of <a href="http://cwe.mitre.org/data/definitions/78.html">OS command Injection</a> was reported. The <a href="http://cwe.mitre.org/index.html">CWE (Common Weakness Enumeration)</a> describes this type of vulnerability as:</p>
<div class="highlight"><pre>    <span class="o">&gt;</span> <span class="p">(...)</span> <span class="n">The</span> <span class="n">software</span> <span class="n">constructs</span> <span class="n">all</span> <span class="n">or</span> <span class="n">part</span> <span class="n">of</span> <span class="n">an</span> <span class="n">OS</span> <span class="n">command</span> <span class="n">using</span> <span class="n">externally</span><span class="o">-</span><span class="n">influenced</span>
    <span class="o">&gt;</span> <span class="n">input</span> <span class="n">from</span> <span class="n">an</span> <span class="n">upstream</span> <span class="n">component</span><span class="p">,</span>  <span class="n">but</span> <span class="n">it</span> <span class="n">does</span> <span class="n">not</span> <span class="n">neutralize</span> <span class="n">or</span> <span class="n">incorrectly</span> <span class="n">neutralizes</span>
    <span class="o">&gt;</span> <span class="n">special</span> <span class="n">elements</span> <span class="n">that</span> <span class="n">could</span> <span class="n">modify</span> <span class="n">the</span> <span class="n">intended</span> <span class="n">OS</span> <span class="n">command</span> <span class="n">when</span> <span class="n">it</span> <span class="n">is</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">a</span> <span class="n">downstream</span>
    <span class="o">&gt;</span> <span class="n">component</span><span class="p">.</span>
</pre></div>


<p>The <strong>Shellshock</strong> vulnerability, also know as <strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271">CVE-2014-6271</a></strong>, allows attackers to inject their own code into <a href="http://www.gnu.org/software/bash/">Bash</a> using specially crafted <strong>environment variables</strong>, and it was disclosed with the following description:</p>
<div class="highlight"><pre>    <span class="o">&gt;</span> <span class="nx">Bash</span> <span class="nx">supports</span> <span class="nx">exporting</span> <span class="nx">not</span> <span class="nx">just</span> <span class="nx">shell</span> <span class="nx">variables</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">also</span> <span class="nx">shell</span>
    <span class="o">&gt;</span> <span class="nx">functions</span> <span class="nx">to</span> <span class="nx">other</span> <span class="nx">bash</span> <span class="nx">instances</span><span class="p">,</span> <span class="nx">via</span> <span class="nx">the</span> <span class="nx">process</span> <span class="nx">environment</span> <span class="nx">to</span>
    <span class="o">&gt;</span> <span class="p">(</span><span class="nx">indirect</span><span class="p">)</span> <span class="nx">child</span> <span class="nx">processes</span><span class="p">.</span>  <span class="nx">Current</span> <span class="nx">bash</span> <span class="nx">versions</span> <span class="nx">use</span> <span class="nx">an</span> <span class="nx">environment</span>
    <span class="o">&gt;</span> <span class="nx">variable</span> <span class="nx">named</span> <span class="nx">by</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">a</span> <span class="kd">function</span> <span class="nx">definition</span>
    <span class="o">&gt;</span> <span class="nx">starting</span> <span class="kd">with</span> <span class="err">“</span><span class="p">()</span> <span class="p">{</span><span class="err">”</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">variable</span> <span class="nx">value</span> <span class="nx">to</span> <span class="nx">propagate</span> <span class="kd">function</span>
    <span class="o">&gt;</span> <span class="nx">definitions</span> <span class="nx">through</span> <span class="nx">the</span> <span class="nx">environment</span><span class="p">.</span>  <span class="nx">The</span> <span class="nx">vulnerability</span> <span class="nx">occurs</span> <span class="nx">because</span>
    <span class="o">&gt;</span> <span class="nx">bash</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">stop</span> <span class="nx">after</span> <span class="nx">processing</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">definition</span><span class="p">;</span> <span class="nx">it</span>
    <span class="o">&gt;</span> <span class="nx">continues</span> <span class="nx">to</span> <span class="nx">parse</span> <span class="nx">and</span> <span class="nx">execute</span> <span class="nx">shell</span> <span class="nx">commands</span> <span class="nx">following</span> <span class="nx">the</span> <span class="kd">function</span>
    <span class="o">&gt;</span> <span class="nx">definition</span><span class="p">.</span>
    <span class="o">&gt;</span> <span class="nx">For</span> <span class="nx">example</span><span class="p">,</span> <span class="nx">an</span> <span class="nx">environment</span> <span class="nx">variable</span> <span class="nx">setting</span> <span class="nx">of</span>
    <span class="o">&gt;</span>
    <span class="o">&gt;</span>  <span class="nx">VAR</span><span class="o">=</span><span class="p">()</span> <span class="p">{</span> <span class="nx">ignored</span><span class="p">;</span> <span class="p">};</span> <span class="err">/bin/id</span>
    <span class="o">&gt;</span>
    <span class="o">&gt;</span> <span class="nx">will</span> <span class="nx">execute</span> <span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">id</span> <span class="nx">when</span> <span class="nx">the</span> <span class="nx">environment</span> <span class="nx">is</span> <span class="nx">imported</span> <span class="nx">into</span> <span class="nx">the</span> <span class="nx">bash</span>
    <span class="o">&gt;</span> <span class="nx">process</span><span class="p">.</span>  <span class="p">(</span><span class="nx">The</span> <span class="nx">process</span> <span class="nx">is</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">slightly</span> <span class="kc">undefined</span> <span class="nx">state</span> <span class="nx">at</span> <span class="k">this</span> <span class="nx">point</span><span class="p">.</span>
    <span class="o">&gt;</span> <span class="nx">The</span> <span class="nx">PATH</span> <span class="nx">variable</span> <span class="nx">may</span> <span class="nx">not</span> <span class="nx">have</span> <span class="nx">been</span> <span class="nx">set</span> <span class="nx">up</span> <span class="nx">yet</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">bash</span> <span class="nx">could</span> <span class="nx">crash</span>
    <span class="o">&gt;</span> <span class="nx">after</span> <span class="nx">executing</span> <span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">id</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">the</span> <span class="nx">damage</span> <span class="nx">has</span> <span class="nx">already</span> <span class="nx">happened</span> <span class="nx">at</span> <span class="k">this</span>
    <span class="o">&gt;</span> <span class="nx">point</span><span class="p">.)</span>
    <span class="o">&gt;</span>
    <span class="o">&gt;</span> <span class="nx">The</span> <span class="nx">fact</span> <span class="nx">that</span> <span class="nx">an</span> <span class="nx">environment</span> <span class="nx">variable</span> <span class="kd">with</span> <span class="nx">an</span> <span class="nx">arbitrary</span> <span class="nx">name</span> <span class="nx">can</span> <span class="nx">be</span>
    <span class="o">&gt;</span> <span class="nx">used</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">carrier</span> <span class="k">for</span> <span class="nx">a</span> <span class="nx">malicious</span> <span class="kd">function</span> <span class="nx">definition</span> <span class="nx">containing</span>
    <span class="o">&gt;</span> <span class="nx">trailing</span> <span class="nx">commands</span> <span class="nx">makes</span> <span class="k">this</span> <span class="nx">vulnerability</span> <span class="nx">particularly</span> <span class="nx">severe</span><span class="p">;</span> <span class="nx">it</span>
    <span class="o">&gt;</span> <span class="nx">enables</span> <span class="nx">network</span><span class="o">-</span><span class="nx">based</span> <span class="nx">exploitation</span><span class="p">.</span>
</pre></div>


<p>Even more scary, the <a href="http://nvd.nist.gov/">NIST vulnerability database</a> has rated <a href="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-6271">this vulnerability “10 out of 10” in terms of severity</a>. At this point, there are people claiming that the <a href="http://www.securityweek.com/shellshock-attacks-could-already-top-1-billion-report?utm_source=feedburner&amp;utm_medium=feed&amp;utm_campaign=Feed%3A+Securityweek+%28SecurityWeek+RSS+Feed%29">Shellshock attacks could already top 1 Billion</a> and <a href="http://www.alienvault.com/open-threat-exchange/blog/attackers-exploiting-shell-shock-cve-2014-6721-in-the-wild">honeypots are catching several exploit payloads</a>. Pretty nasty stuff, huh?</p>
<p>I thought so. So I decided it would be worth to write a comprehensive guide about it. There are a lot of things I want to talk about so I divided this guide in two. In this first part, I  explain:</p>
<div class="highlight"><pre>    <span class="mi">1</span><span class="p">.</span> <span class="nx">Bash</span> <span class="nx">functions</span> <span class="nx">and</span> <span class="nx">environment</span> <span class="nx">variables</span><span class="p">.</span>
    <span class="mi">2</span><span class="p">.</span> <span class="nx">What</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">the</span> <span class="nx">Shellshock</span> <span class="nx">vulnerability</span><span class="p">.</span>
    <span class="mi">3</span><span class="p">.</span> <span class="nx">Suggestions</span> <span class="nx">of</span> <span class="nx">how</span> <span class="nx">to</span> <span class="nx">protect</span> <span class="nx">your</span> <span class="nx">system</span><span class="p">.</span>
</pre></div>


<p>In the second part I take a deeper look at this vulnerability, explaining:</p>
<div class="highlight"><pre>    <span class="mf">4.</span> <span class="n">More</span> <span class="n">details</span> <span class="n">about</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2014</span><span class="o">-</span><span class="mi">6271</span> <span class="n">and</span> <span class="n">the</span> <span class="n">four</span> <span class="n">others</span> <span class="n">CVEs</span> <span class="n">that</span> <span class="n">were</span> <span class="n">created</span> <span class="n">after</span> <span class="n">it</span><span class="p">.</span>
    <span class="mf">5.</span> <span class="n">The</span> <span class="n">systems</span> <span class="n">that</span> <span class="n">are</span> <span class="n">vulnerable</span><span class="p">,</span> <span class="n">with</span> <span class="n">some</span> <span class="n">proof</span> <span class="n">of</span> <span class="n">concept</span> <span class="n">code</span><span class="p">.</span>
    <span class="mf">6.</span> <span class="n">Details</span> <span class="n">of</span> <span class="n">how</span> <span class="n">the</span> <span class="n">patches</span> <span class="n">were</span> <span class="n">created</span><span class="p">.</span>
</pre></div>


<p>Ready?</p>
<hr />
<h2>Understanding the Bash Shell</h2>
<p>To understand this vulnerability, we need to understand how Bash handles functions and environment variables.</p>
<p>The <a href="http://www.gnu.org/software/bash/">GNU Bourne Again shell (BASH)</a> is a <a href="http://en.wikipedia.org/wiki/Bash_(Unix_shell)">Unix shell</a> and <a href="http://en.wikipedia.org/wiki/Command-line_interface">command language interpreter</a>. It was released in 1989  by <a href="http://en.wikipedia.org/wiki/Brian_Fox_(computer_programmer)">Brian Fox</a> for the <a href="http://www.gnu.org/gnu/thegnuproject.html">GNU Project</a> as a free software replacement for the <a href="http://en.wikipedia.org/wiki/Bourne_shell">Bourne shell</a> (which was born back in 1977).</p>
<div class="highlight"><pre><span class="nv">$ </span>man bash

BASH<span class="o">(</span>1<span class="o">)</span>                      General Commands Manual                      BASH<span class="o">(</span>1<span class="o">)</span>

NAME
       bash - GNU Bourne-Again SHell

SYNOPSIS
       bash <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>file<span class="o">]</span>

COPYRIGHT
       Bash is Copyright <span class="o">(</span>C<span class="o">)</span> 1989-2011 by the Free Software Foundation, Inc.

DESCRIPTION
       Bash  is  an sh-compatible <span class="nb">command </span>language interpreter that executes com‐
       mands <span class="nb">read </span>from the standard input or from a file.  Bash also incorporates
       useful features from the Korn and C shells <span class="o">(</span>ksh and csh<span class="o">)</span>.
<span class="o">(</span>...<span class="o">)</span>
</pre></div>


<p>Of course, there are <a href="http://en.wikipedia.org/wiki/Comparison_of_command_shells">other command shells out there</a>. However, Bash is the default shell for most of the Linux systems (and Linux-based systems), including many Debian-based distributions and the Red Hat &amp; Fedora &amp; CentOS combo.</p>
<h3>Functions in Bash</h3>
<p>The interesting stuff comes from the fact that Bash  is also a scripting language, with the ability to define functions. This is super useful when you are writing scripts. For example, <code>hello.sh</code>:</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="k">function </span>hello <span class="o">{</span>
  <span class="nb">echo </span>Hello!
<span class="o">}</span>
hello
</pre></div>


<p>which can be called as:</p>
<div class="highlight"><pre><span class="nv">$ </span>chmod a+x hello.sh
<span class="nv">$ </span>./hello.sh
Hello!
</pre></div>


<p>A function may be compacted into a single line. You just need to choose a name and put a <code>()</code> after it. Everything inside <code>{}</code> will belong to the scope of your function.</p>
<p>For example, we can create a function <code>bashiscool</code> that uses <code>echo</code>  to display message on the standard output:</p>
<div class="highlight"><pre><span class="nv">$ </span>bashiscool<span class="o">()</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;Bash is actually Fun&quot;</span>; <span class="o">}</span>
<span class="nv">$ </span>bashiscool
Bash is actually Fun
</pre></div>


<h3>Child Processes   and the  <code>export</code>  command</h3>
<p>We can make things even more interesting. The statement <code>bash -c</code> can be used to execute a new instance of Bash, as a subprocess,  to run new commands. The catch is that the child process does not inherit the functions  or variables that we defined in the parent:</p>
<div class="highlight"><pre><span class="nv">$ </span>bash -c bashiscool <span class="c"># spawn nested shell</span>
bash: bashiscool: <span class="nb">command </span>not found
</pre></div>


<p>So before executing a new instance of Bash, we need to export the <strong>environment variables</strong> to the child. That's why we need the <code>export</code> command. In the example bellow, the flag <code>-f</code> means <em>read key bindings from filename</em>:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">export</span> -f bashiscool
<span class="nv">$ </span>bash -c bashiscool <span class="c"># spawn nested shell</span>
Bash is actually Fun
</pre></div>


<p>In other words, first the <code>export</code> command creates a <strong>regular environment variable</strong> containing the function definition. Then, the second shell reads the environment. If it sees a variable that look like a function, it evaluates this function!</p>
<h3>A Simple Example of an Environment Variable</h3>
<p>Let's  see how environment variables work examining some builtin Bash command. For instance, a very popular one,  <code>grep</code>, is used to search for pattern in files (or the standard input).</p>
<p>Running <code>grep</code> in a file that contains the word 'fun' will return the line where this word is. Running <code>grep</code> with a flag <code>-v</code> will return the non-matching lines, <em>i.e.</em> the lines where the word 'fun' does not appear:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;bash can be super fun&#39;</span> &gt; file.txt
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;bash can be dangerous&#39;</span> &gt;&gt; file.txt
<span class="nv">$ </span>cat file.txt
 bash can be super fun
 bash can be dangerous
<span class="nv">$ </span>grep fun file.txt
 bash can be super fun
<span class="nv">$ </span>grep -v fun file.txt
 bash can be dangerous
</pre></div>


<p>The <code>grep</code> command uses an environment variable called <strong>GREP_OPTIONS</strong> to set default options. This variable is usually set to:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GREP_OPTIONS</span>
--color<span class="o">=</span>auto
</pre></div>


<p>To update or create a new environment variable, it is not enough to use the Bash syntax <code>GREP_OPTIONS='-v'</code>, but instead we  need to call the <em>builtin</em> <code>export</code>:</p>
<div class="highlight"><pre><span class="nv">$ GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;-v&#39;</span>
<span class="nv">$ </span>grep fun file.txt
 bash can be super fun
<span class="nv">$ </span><span class="nb">export </span><span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;-v&#39;</span>
<span class="nv">$ </span>grep fun file.txt
 bash can be dangerous
</pre></div>


<h3>The  <code>env</code>  command</h3>
<p>Another Bash builtin, the <code>env</code>  prints the environment variables. But it can also  be used to run a single command with an exported variable (or variables) given to that command. In this case, <code>env</code> starts a new process, then it modifies the environment, and then it calls the command that was provided as an argument (the <code>env</code> process is  replaced by the command process).</p>
<p>In practice, to use <code>env</code>  to run commands, we:</p>
<div class="highlight"><pre>    <span class="mi">1</span><span class="p">.</span> <span class="nx">set</span> <span class="nx">the</span> <span class="nx">environment</span> <span class="nx">variable</span> <span class="nx">value</span> <span class="kd">with</span> <span class="nx">env</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">.</span> <span class="nx">spawn</span> <span class="nx">a</span> <span class="k">new</span> <span class="nx">shell</span> <span class="nx">using</span> <span class="nx">bash</span> <span class="o">-</span><span class="nx">c</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">.</span> <span class="nx">pass</span> <span class="nx">the</span> <span class="nx">command</span><span class="o">/</span><span class="kd">function</span> <span class="nx">we</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">run</span> <span class="p">(</span><span class="k">for</span> <span class="nx">example</span><span class="p">,</span> <span class="nx">grep</span> <span class="nx">fun</span> <span class="nx">file</span><span class="p">.</span><span class="nx">txt</span><span class="p">).</span>
</pre></div>


<p>For example:</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;-v&#39;</span> | grep fun file.txt    <span class="c"># this does not work, we need another shell</span>
bash can be super fun
<span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;-v&#39;</span> bash -c <span class="s1">&#39;grep fun file.txt&#39;</span>  <span class="c"># here we go</span>
bash can be dangerous
</pre></div>


<h3>Facing the Shellshock Vulnerability</h3>
<p>What if we pass some function to the variable definition?</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;() { :;};&#39;</span> bash -c <span class="s1">&#39;grep fun file.txt&#39;</span>
grep: <span class="o">{</span>: No such file or directory
grep: :;<span class="o">}</span>;: No such file or directory
grep: fun: No such file or directory
</pre></div>


<p>Since the things we added are strange when parsed to the command <code>grep</code>, it won't understand them.</p>
<p>What if we add stuff <em>after</em> the function? Things start to get weirder:</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;-v () { :;}; echo NOOOOOOOOOOOOOOO!&#39;</span> bash -c <span class="s1">&#39;grep fun file.txt&#39;</span>
grep: <span class="o">{</span>: No such file or directory
grep: :;<span class="o">}</span>;: No such file or directory
grep: <span class="nb">echo</span>: No such file or directory
grep: NOOOOOOOOOOOOOOO!: No such file or directory
grep: fun: No such file or directory
file.txt:bash can be super fun
file.txt:bash can be dangerous
</pre></div>


<p>Did you notice the confusion? <em>Both</em> matches and non-matches were printed! It means that some stuff was parsed well, and some other was not. In doubt, Bash does <em>everything</em>.</p>
<p>Now, what if we just keep the function, taking out the only thing that makes sense, <code>-v</code>?</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;() { :;}; echo NOOOOOOOOOOOOOOO!&#39;</span> bash -c <span class="s1">&#39;grep fun file.txt&#39;</span>
NOOOOOOOOOOOOOOO!
grep: <span class="o">{</span>: No such file or directory
grep: :: No such file or directory
grep: <span class="o">}</span>: No such file or directory
grep: fun: No such file or directory
</pre></div>


<p>Did you notice that <code>echo NOOOOOOOOOOOOOOO!</code> was executed normally? <strong>This is the Shellshock bug!</strong></p>
<p>This works because when the new shell sees an environment variable beginning with <code>()</code>, it gets the variable name and executes the  string following it. This  includes executing anything after the function, <em>i.e</em>, the evaluation does not stop when the end of the function definition is reached!</p>
<p>Remember that <code>echo</code> is not the only thing we can do. The possibilities are unlimited! For example, we can issue any <code>/bin</code> command:</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s1">&#39;() { :;}; /bin/ls&#39;</span> bash -c <span class="s1">&#39;grep fun file.txt&#39;</span>
anaconda  certificates  file.txt  IPython
<span class="o">(</span>...<span class="o">)</span>
</pre></div>


<p>WOW.</p>
<p>Worse, we  actually don't need to use a system environment variable nor even call a real command:</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nb">test</span><span class="o">=</span><span class="s1">&#39;() { :;}; echo STILL NOOOOOOOO!!!!&#39;</span> bash -c :
STILL NOOOOOOOO!!!!
</pre></div>


<p>In the example above, <code>env</code> runs a command with an arbitrary  variable  (test)  set to some function (in this case is just a single <code>:</code>, a Bash command defined as doing nothing). The semi-colon signals the end of the function definition. Again, the bug is in the fact that there's nothing stopping the parsing of what is after the semi-colon!</p>
<p>Now it's easy to see if your system is vulnerable, all you need to do is run:</p>
<div class="highlight"><pre><span class="nv">$ </span>env <span class="nv">x</span><span class="o">=</span><span class="s1">&#39;() { :;}; echo The system is vulnerable!&#39;</span> bash -c :
</pre></div>


<p>That simple.</p>
<hr />
<h2>How to Protect Your System</h2>
<p>Although a patch for CVE-2014-6271 was released right after the bug was disclosed, it was  incomplete and new issues were tracked  as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7169">CVE-2014-7169</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7186">CVE-2014-7186</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7187">CVE-2014-7187</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6277">CVE-2014-6277</a>, and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6278">CVE-2014-6278</a> (I will talk about them in the part II, including how to test your system for each of them). Several patches have been released since then. The fight is not over yet and I recommend the follow measures:</p>
<ul>
<li>Update your system!  And keep updating it... Many Linux distributions have released new Bash software versions so follow the instructions of your distribution. In most of the cases, a simple <code>yum update</code> or <code>apt-get update</code> or similar will do it. If you have several servers, the script bellow can be helpful:</li>
</ul>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">servers</span><span class="o">=(</span>
120.120.120.120
10.10.10.10
22.22.22.22
<span class="o">)</span>
<span class="k">for </span>server in <span class="k">${</span><span class="nv">servers</span><span class="p">[@]</span><span class="k">}</span>
<span class="k">do</span>
ssh <span class="nv">$server</span> <span class="s1">&#39;yum -y update bash&#39;</span>
<span class="k">done</span>
</pre></div>


<ul>
<li>
<p>HTTP requests to CGI scripts have been identified as the major attack vector (I will show more  details in the part II). So disable any CGI scripts that call on the shell (however, it does not fully mitigate the vulnerability). To check if your system is vulnerable you can use <a href="http://milankragujevic.com/projects/shellshock/">this online scanner</a>. Consider <a href="https://www.modsecurity.org/">mod_security</a> if you're not already using it.</p>
</li>
<li>
<p>Keep an eye on all of your accounts for signs of unusual activity. Consider changing important passwords.</p>
</li>
<li>
<p>Because the HTTP requests used by Shellshock exploits are quite unique, monitor logs with keywords such as <code>grep '() {'  access_log</code>or <code>cat access_log |grep "{ :;};"</code>. Some common places for http logs are: <code>cPanel: /usr/local/apache/domlogs/</code>, <code>Debian/Apache: /var/log/apache2/</code>, or <code>CentOS: /var/log/httpd/</code>.</p>
</li>
<li>
<p>If case of an attack, publish the attacker's information! You can use <a href="http://www.grymoire.com/Unix/Awk.html">awk</a>  and  <a href="http://en.wikipedia.org/wiki/Uniq">uniq</a> (where <em>print $1</em> means print the first column) to get its IP, for example:</p>
</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>cat log_file |grep <span class="s2">&quot;{ :;};&quot;</span> | awk <span class="s1">&#39;{print $1}&#39;</span>|uniq
</pre></div>


<ul>
<li>
<p>Update firmware on your router or any other web-enabled devices, as soon as they become available. Remember  to only download patches  from reputable sites (only HTTPS please!), since scammers will likely try to take advantage of Shellshock reports.</p>
</li>
<li>
<p>If you are on a managed hosting subscription, check your company's status. For example: <a href="https://docs.acquia.com/articles/september-2014-gnu-bash-upstream-security-vulnerability">Acquia</a>, <a href="https://status.heroku.com/incidents/665">Heroku</a>, <a href="http://status.mediatemple.net/">Mediatemple</a>, and <a href="https://status.rackspace.com/">Rackspace</a>.</p>
</li>
<li>
<p>Update your Docker containers and  AWS instances.</p>
</li>
<li>
<p>If you are running production systems that don't need exported functions at all, take a look at <a href="https://github.com/dlitz/bash-shellshock">this wrapper</a> that refuses to run bash if any environment variable's value starts with a left-parent.</p>
</li>
</ul>
<h4><a href="">Want to learn even more? Check  Part II</a>.</h4>
<hr />
<h2>Further  References</h2>
<p><a href="http://stephane.chazelas.free.fr">http://stephane.chazelas.free.fr/</a></p>
<p><a href="https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack">https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack</a></p>
<p><a href="http://lcamtuf.blogspot.co.uk/2014/09/quick-notes-about-bash-bug-its-impact.html">http://lcamtuf.blogspot.co.uk/2014/09/quick-notes-about-bash-bug-its-impact.html</a></p>
<p><a href="http://www.openwall.com/lists/oss-security/2014/09/24/11">http://www.openwall.com/lists/oss-security/2014/09/24/11</a></p>
<p><a href="http://blog.erratasec.com/2014/09/bash-bug-as-big-as-heartbleed.html#.VCNbefmSx8G">http://blog.erratasec.com/2014/09/bash-bug-as-big-as-heartbleed.html#.VCNbefmSx8G</a></p>
<p><a href="http://seclists.org/oss-sec/2014/q3/649">http://seclists.org/oss-sec/2014/q3/649</a></p>
<p><a href="http://www.circl.lu/pub/tr-27/#recommendations">http://www.circl.lu/pub/tr-27/#recommendations</a></p>
<p><a href="http://www.troyhunt.com/2014/09/everything-you-need-to-know-about.html">http://www.troyhunt.com/2014/09/everything-you-need-to-know-about.html</a></p>
<hr />
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "understanding-the-shellshock-vulnerability-part-i.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://bt3gl.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">



<li class="nav-header"><h4>Categories</h4></li>
<li>
<a href="http://bt3gl.github.io/category/vulnerabilities.html">
    <i class="icon-folder-open icon-large"></i>Vulnerabilities
</a>
</li>
<li>
<a href="http://bt3gl.github.io/category/reverse-engineering.html">
    <i class="icon-folder-open icon-large"></i>Reverse Engineering
</a>
</li>
<li>
<a href="http://bt3gl.github.io/category/networking.html">
    <i class="icon-folder-open icon-large"></i>Networking
</a>
</li>
<li>
<a href="http://bt3gl.github.io/category/forensics.html">
    <i class="icon-folder-open icon-large"></i>Forensics
</a>
</li>
<li>
<a href="http://bt3gl.github.io/category/cryptography.html">
    <i class="icon-folder-open icon-large"></i>Cryptography
</a>
</li>

<br>

<li class="nav-header"><h4>Tags</h4></li>
<ul class="tagcloud">
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/pygenere.html">
        <i class="icon-tag icon-large"></i>pygenere
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/steganography.html">
        <i class="icon-tag icon-large"></i>Steganography
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/readelf.html">
        <i class="icon-tag icon-large"></i>readelf
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/jad.html">
        <i class="icon-tag icon-large"></i>jad
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/rot13.html">
        <i class="icon-tag icon-large"></i>ROT13
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/vigenere.html">
        <i class="icon-tag icon-large"></i>Vigenere
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/qpdf.html">
        <i class="icon-tag icon-large"></i>qpdf
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/pdftotext.html">
        <i class="icon-tag icon-large"></i>pdftotext
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/mem.html">
        <i class="icon-tag icon-large"></i>mem
    </a>
</li>
<li class="tag-1">
    <a href="http://bt3gl.github.io/tag/csaw.html">
        <i class="icon-tag icon-large"></i>CSAW
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/outguess.html">
        <i class="icon-tag icon-large"></i>OutGuess
    </a>
</li>
<li class="tag-1">
    <a href="http://bt3gl.github.io/tag/ctf.html">
        <i class="icon-tag icon-large"></i>CTF
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/shellshock.html">
        <i class="icon-tag icon-large"></i>Shellshock
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/socket.html">
        <i class="icon-tag icon-large"></i>socket
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/bash.html">
        <i class="icon-tag icon-large"></i>Bash
    </a>
</li>
<li class="tag-3">
    <a href="http://bt3gl.github.io/tag/pdf-parser.html">
        <i class="icon-tag icon-large"></i>pdf-parser
    </a>
</li>
<li class="tag-3">
    <a href="http://bt3gl.github.io/tag/wireshark.html">
        <i class="icon-tag icon-large"></i>Wireshark
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/command-injection.html">
        <i class="icon-tag icon-large"></i>Command Injection
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/chaosreader.html">
        <i class="icon-tag icon-large"></i>Chaosreader
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/hashcat.html">
        <i class="icon-tag icon-large"></i>hashcat
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/javascript.html">
        <i class="icon-tag icon-large"></i>JavaScript
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/telnet.html">
        <i class="icon-tag icon-large"></i>telnet
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/ftp.html">
        <i class="icon-tag icon-large"></i>FTP
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/lamp.html">
        <i class="icon-tag icon-large"></i>LAMP
    </a>
</li>
<li class="tag-4">
    <a href="http://bt3gl.github.io/tag/uncompyle2.html">
        <i class="icon-tag icon-large"></i>uncompyle2
    </a>
</li>


</ul>

        </div><!--/.well -->

      </div><!--/row-->



      <footer>
        <address id="about">

        </address><!-- /#about -->

      </footer>

    </div><!--/.fluid-container-->


    <script src="http://bt3gl.github.io/theme/js/jquery-1.7.2.min.js"></script>
    <script src="http://bt3gl.github.io/theme/js/bootstrap.min.js"></script>
  </body>
</html>